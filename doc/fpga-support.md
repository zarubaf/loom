<!-- SPDX-License-Identifier: Apache-2.0 -->
# FPGA Support — Alveo U250 + PCIe XDMA

## Overview

Loom supports running transformed DUTs on an Alveo U250 FPGA with PCIe host
communication. The same `loom_emu_top` module used in simulation is reused
on FPGA — only the transport layer and top-level wrapper differ.

## Architecture

```
loom_fpga_top.sv
├── IBUFDS_GTE4         (PCIe 100 MHz refclk buffer)
├── IBUFDS              (300 MHz emulation refclk buffer)
├── xlnx_xdma           (PCIe X2 Gen3 → AXI-Lite master @ 125 MHz)
├── loom_axil_demux #(N_MASTERS=2)
│   ├── [0x0_0000] → xlnx_axi_clock_converter → loom_emu_top (@ emu_clk)
│   └── [0x8_0000] → xlnx_clk_gen DRP slave (@ 125 MHz, no CDC)
├── xlnx_clk_gen        (300 MHz → programmable emu_clk, DRP reconfigurable)
├── xlnx_axi_clock_converter (AXI-Lite CDC: 125 MHz ↔ emu_clk)
├── reset synchronizer  (clk_gen locked + pcie_aresetn → emu_rst_n)
└── loom_emu_top        (UNCHANGED — same module as simulation)
```

## Address Map

The PCIe BAR exposes a 1 MB AXI-Lite address space:

| Range | Target | Clock Domain |
|-------|--------|-------------|
| `0x0_0000 – 0x7_FFFF` | loom_emu_top (via CDC) | emu_clk |
| `0x8_0000 – 0xF_FFFF` | Clock generator DRP | pcie_aclk (125 MHz) |

Within the emu_top range (same as simulation):

| Range | Target |
|-------|--------|
| `0x0_0000 – 0x0_00FF` | emu_ctrl |
| `0x0_0100 – 0x0_FFFF` | dpi_regfile |
| `0x2_0000 – 0x2_FFFF` | scan_ctrl |

## Key Design Decisions

- **Unified demux**: `loom_axil_demux` is parameterizable with `N_MASTERS`,
  `BASE_ADDR`/`ADDR_MASK`. Used both inside `loom_emu_top` (3 masters) and
  in `loom_fpga_top` (2 masters).
- **CDC**: Xilinx `axi_clock_converter` IP handles clock crossing between
  PCIe (125 MHz) and emulation domains.
- **No DDR4**: v1 uses register-only AXI-Lite access.
- **No ifdefs**: Separate top-levels (`loom_sim_top` vs `loom_fpga_top`),
  shared everything else.
- **Polling**: v1 uses polling for DPI service (no IRQ).

## Clock Generator

The emulation clock is generated by a Xilinx `clk_wiz` IP with DRP
(Dynamic Reconfiguration Port) enabled. The host can reprogram the emulation
clock frequency at runtime by writing to the DRP registers at `0x8_0000`.

Default output frequency: 50 MHz (from 300 MHz input).

## Host Transport

`loomx -t xdma` uses the XDMA transport (`loom_transport_xdma.cpp`) which
accesses the FPGA via:

```
/dev/xdma0_user → pread/pwrite → AXI-Lite registers
```

The `Context`, `DpiService`, and shell are shared with simulation mode.
The shell `read`/`write` commands provide direct register access for
debugging.

## Build Flow

```bash
# 1. Generate Xilinx IPs (one-time)
make -C fpga ip

# 2. Transform DUT (reuse simulation flow)
make -C tests/e2e transform

# 3. Build bitstream
make -C fpga bitstream TRANSFORMED_V=tests/e2e/build/transformed.v

# 4. Program FPGA
make -C fpga program

# 5. Run via loomx
loomx -work tests/e2e/build -t xdma -sv_lib tests/e2e/build/dpi
```

## Files

| File | Purpose |
|------|---------|
| `src/fpga/loom_fpga_top.sv` | FPGA top-level |
| `src/rtl/loom_axil_demux.sv` | Parameterizable AXI-Lite 1:N demux |
| `src/host/loom_transport_xdma.cpp` | PCIe/XDMA transport |
| `fpga/Makefile` | Build orchestration |
| `fpga/boards/u250/` | Board settings and constraints |
| `fpga/ip/` | Xilinx IP generation scripts |
| `fpga/scripts/` | Vivado synthesis/implementation/programming |
| `tests/e2e/Makefile` | E2E test (sim: `make run`, FPGA: `make fpga-run`) |

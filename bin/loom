#!/bin/bash
# SPDX-License-Identifier: Apache-2.0
# loom - CLI wrapper for Loom FPGA emulation toolchain

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PREFIX="${SCRIPT_DIR%/bin}"

# Plugin paths (relative to install prefix)
YOSYS_BIN="${PREFIX}/bin/yosys"
SLANG_PLUGIN="${PREFIX}/lib/loom/slang.so"
SCAN_INSERT_PLUGIN="${PREFIX}/lib/loom/scan_insert.so"
DPI_BRIDGE_PLUGIN="${PREFIX}/lib/loom/dpi_bridge.so"
MEM_SHADOW_PLUGIN="${PREFIX}/lib/loom/mem_shadow.so"

# Generation script
LOOM_GEN_SIM="${PREFIX}/scripts/loom_gen_sim.py"
LOOM_SRC="${PREFIX}/src"

# Default options
FILELIST=""
OUTPUT=""
TOP_MODULE=""
SCAN_ONLY=false
DPI_BRIDGE=false
MEM_SHADOW=false
MEM_MAP=""
GEN_SIM=false
GEN_SIM_DIR=""
DPI_JSON=""
VERBOSE=false

usage() {
    cat <<EOF
Loom - Open-Source FPGA Emulation Toolchain

Usage: loom [options] -f <filelist> -o <output.v>

Options:
  -f, --filelist FILE     Input filelist (required)
  -o, --output FILE       Output Verilog file (required)
  -top, --top MODULE      Top module name (auto-detected if not specified)
  --scan-only             Only insert scan chains, skip DPI bridge
  --dpi-bridge            Include DPI-to-hardware bridge conversion
  --dpi-json FILE         Output DPI metadata JSON file (auto-set with --gen-sim)
  --mem-shadow            Add unified shadow ports to memories for debug access
  --mem-map FILE          Output memory map JSON file (requires --mem-shadow)
  --gen-sim DIR           Generate simulation infrastructure in DIR
  -v, --verbose           Verbose output
  -h, --help              Show this help message
  --version               Show version information

Examples:
  loom -f design.f -o synthesized.v
  loom -f design.f -o synthesized.v -top my_soc --dpi-bridge
  loom -f design.f -o synthesized.v --mem-shadow --mem-map mem_map.json
  loom -f design.f -o out.v -top dut --gen-sim sim/  # Generate simulation files

Signal naming convention:
  All Loom-generated signals use the 'loom_' prefix:
    - loom_scan_enable, loom_scan_in, loom_scan_out (scan chain)
    - loom_dpi_valid, loom_dpi_func_id, loom_dpi_args, loom_dpi_result, loom_dpi_ready (DPI)
    - loom_shadow_clk, loom_shadow_addr, loom_shadow_wdata, loom_shadow_rdata,
      loom_shadow_wen, loom_shadow_ren (memory shadow access)

EOF
    exit 0
}

version() {
    echo "Loom FPGA Emulation Toolchain v0.1.0"
    exit 0
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        -f|--filelist)
            FILELIST="$2"
            shift 2
            ;;
        -o|--output)
            OUTPUT="$2"
            shift 2
            ;;
        -top|--top)
            TOP_MODULE="$2"
            shift 2
            ;;
        --scan-only)
            SCAN_ONLY=true
            shift
            ;;
        --dpi-bridge)
            DPI_BRIDGE=true
            shift
            ;;
        --mem-shadow)
            MEM_SHADOW=true
            shift
            ;;
        --mem-map)
            MEM_MAP="$2"
            shift 2
            ;;
        --gen-sim)
            GEN_SIM=true
            GEN_SIM_DIR="$2"
            DPI_BRIDGE=true  # --gen-sim implies --dpi-bridge
            shift 2
            ;;
        --dpi-json)
            DPI_JSON="$2"
            shift 2
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        -h|--help)
            usage
            ;;
        --version)
            version
            ;;
        *)
            echo "Error: Unknown option $1" >&2
            exit 1
            ;;
    esac
done

# Validate required arguments
if [[ -z "$FILELIST" ]]; then
    echo "Error: Input filelist (-f) is required" >&2
    exit 1
fi

if [[ -z "$OUTPUT" ]]; then
    echo "Error: Output file (-o) is required" >&2
    exit 1
fi

if [[ ! -f "$FILELIST" ]]; then
    echo "Error: Filelist not found: $FILELIST" >&2
    exit 1
fi

# Build Yosys command
YOSYS_CMD=""

# Load plugins
YOSYS_CMD+="plugin -i $SLANG_PLUGIN; "
YOSYS_CMD+="plugin -i $SCAN_INSERT_PLUGIN; "
if [[ "$DPI_BRIDGE" == true ]]; then
    YOSYS_CMD+="plugin -i $DPI_BRIDGE_PLUGIN; "
fi
if [[ "$MEM_SHADOW" == true ]]; then
    YOSYS_CMD+="plugin -i $MEM_SHADOW_PLUGIN; "
fi

# Read design using slang frontend with filelist
YOSYS_CMD+="read_slang -F $FILELIST"
if [[ -n "$TOP_MODULE" ]]; then
    YOSYS_CMD+=" --top $TOP_MODULE"
fi
YOSYS_CMD+="; "

# Elaborate
YOSYS_CMD+="hierarchy -check"
if [[ -n "$TOP_MODULE" ]]; then
    YOSYS_CMD+=" -top $TOP_MODULE"
fi
YOSYS_CMD+="; "

# Initial processing
YOSYS_CMD+="proc; opt; "

# Memory shadow ports (must run before flatten)
if [[ "$MEM_SHADOW" == true ]]; then
    YOSYS_CMD+="memory_collect; memory_dff; "
    if [[ -n "$MEM_MAP" ]]; then
        YOSYS_CMD+="mem_shadow -map $MEM_MAP; "
    else
        YOSYS_CMD+="mem_shadow; "
    fi
fi

# Flatten and optimize for subsequent passes
YOSYS_CMD+="flatten; opt; "

# Insert scan chains
if [[ "$SCAN_ONLY" == false ]] || [[ "$DPI_BRIDGE" == false ]]; then
    YOSYS_CMD+="scan_insert; "
fi

# DPI bridge if requested
if [[ "$DPI_BRIDGE" == true ]]; then
    # If generating simulation or explicit JSON output, add -json_out
    if [[ "$GEN_SIM" == true ]] && [[ -z "$DPI_JSON" ]]; then
        DPI_JSON="${GEN_SIM_DIR}/dpi_metadata.json"
    fi
    if [[ -n "$DPI_JSON" ]]; then
        YOSYS_CMD+="dpi_bridge -json_out $DPI_JSON; "
    else
        YOSYS_CMD+="dpi_bridge; "
    fi
fi

# Final cleanup and output
YOSYS_CMD+="opt_clean; "
YOSYS_CMD+="write_verilog -noattr $OUTPUT"

# Execute Yosys
if [[ "$VERBOSE" == true ]]; then
    echo "Running: $YOSYS_BIN -p \"$YOSYS_CMD\""
fi

"$YOSYS_BIN" -p "$YOSYS_CMD"
YOSYS_RC=$?

if [[ $YOSYS_RC -ne 0 ]]; then
    echo "Error: Yosys failed with exit code $YOSYS_RC" >&2
    exit $YOSYS_RC
fi

# Generate simulation infrastructure if requested
if [[ "$GEN_SIM" == true ]]; then
    echo "Generating simulation infrastructure in $GEN_SIM_DIR..."

    if [[ -z "$TOP_MODULE" ]]; then
        echo "Error: --top is required with --gen-sim" >&2
        exit 1
    fi

    if [[ ! -f "$DPI_JSON" ]]; then
        echo "Error: DPI JSON file not found: $DPI_JSON" >&2
        exit 1
    fi

    mkdir -p "$GEN_SIM_DIR"

    # Get absolute path to output file
    OUTPUT_ABS="$(cd "$(dirname "$OUTPUT")" && pwd)/$(basename "$OUTPUT")"

    python3 "$LOOM_GEN_SIM" \
        --dpi-json "$DPI_JSON" \
        --module "$TOP_MODULE" \
        --dut-sv "$OUTPUT_ABS" \
        --loom-src "$LOOM_SRC" \
        --output-dir "$GEN_SIM_DIR"

    echo "Simulation infrastructure generated in $GEN_SIM_DIR"
    echo "To build and run: cd $GEN_SIM_DIR && make test"
fi

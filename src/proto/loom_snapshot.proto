// SPDX-License-Identifier: Apache-2.0
syntax = "proto3";
package loom;
option optimize_for = LITE_RUNTIME;

// Enum member name-to-value mapping (for symbolic display)
message EnumMember {
  string name = 1;     // e.g. "StIdle"
  uint64 value = 2;    // e.g. 0
}

// One per FF/register — already grouped at compile time
message ScanVariable {
  string name = 1;     // original HDL path from hdlname attr, dot-separated
  uint32 width = 2;    // total bit width of the variable
  uint32 offset = 3;   // starting chain position (bits [offset..offset+width-1])
  repeated EnumMember enum_members = 4;  // empty if not an enum type
  bytes reset_value = 5;  // LE-packed reset value (empty = no reset / default 0)
}

// DPI call to execute at initialization time (before scan-in)
message DpiInitCall {
  string func_name = 1;        // DPI function name (lookup key in dispatch table)
  bytes arg_data = 2;          // LE-packed constant arguments (uint32_t words)
  string arg_widths = 3;       // comma-separated per-arg widths
  string arg_types = 4;        // comma-separated arg types
  string arg_dirs = 5;         // comma-separated arg directions
  uint32 return_width = 6;     // 0 for void initial calls
  uint32 scan_offset = 7;      // bit offset in scan chain (only if return_width > 0)
  uint32 scan_width = 8;       // width of return value in scan chain
  map<uint32, string> string_args = 9;  // index -> string value for string args
}

message ScanMap {
  uint32 chain_length = 1;
  repeated ScanVariable variables = 2;
  bytes initial_scan_image = 3;  // pre-built full chain blob for scan-based init
  repeated DpiInitCall initial_dpi_calls = 4;  // DPI calls to execute before scan-in
}

// Single state snapshot (dump file)
message Snapshot {
  uint64 cycle_count = 1;
  uint64 dut_time = 2;
  uint32 design_id = 3;
  bytes  raw_scan_data = 4;        // raw chain words packed LE
  ScanMap scan_map = 5;            // embedded — makes file self-contained
}

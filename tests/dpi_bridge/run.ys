# SPDX-License-Identifier: Apache-2.0
# Test DPI bridge pass with automatic DPI detection
# Verifies that yosys-slang creates $__loom_dpi_call cells for DPI imports
# and that dpi_bridge pass converts them to hardware bridge interfaces

# Read using slang frontend (automatically detects DPI imports)
read_slang ../fixtures/dpi_example.sv

hierarchy -check -top dpi_example
proc

# Show design before DPI bridge pass
stat

# Run DPI bridge pass
dpi_bridge -gen_wrapper

# Check that loom_dpi_* interface ports were added
select -assert-count 1 w:\loom_dpi_req
select -assert-count 1 w:\loom_dpi_ack
select -assert-count 1 w:\loom_dpi_func_id
select -assert-count 1 w:\loom_dpi_args
select -assert-count 1 w:\loom_dpi_result

# Show final design
stat

# Write output for inspection
write_verilog e2e_output.v

# SPDX-License-Identifier: Apache-2.0
# Test emu_top wrapper generation pass
# Verifies that emu_top creates a wrapper with loom_en (no clock gating)

# Read the test design with DPI call
read_slang --loom ../fixtures/dpi_example.sv

hierarchy -check -top dpi_example
proc

log "=== Before transformation ==="
stat

# Run scan insertion
scan_insert

# Run loom_instrument pass to convert DPI calls and add flop enable
loom_instrument

log "=== After scan insertion and loom_instrument ==="
stat

# Generate emu_top wrapper
emu_top -top dpi_example -clk clk -rst rst

log "=== After emu_top generation ==="
stat

# Verify wrapper module was created with correct structure
select -assert-count 1 loom_emu_top/c:u_dut

# Verify DUT has loom_en port (created by loom_instrument)
select -assert-count 1 dpi_example/w:loom_en

# Verify wrapper has loom_en_wire (computed by emu_top)
select -assert-count 1 loom_emu_top/w:loom_en_wire

# Clear selection
select -clear

# Check design validity
check

# Write output for inspection
write_verilog emu_top_output.v
